<!DOCTYPE html>
<html id="rootObject">
    <head>
        <style>
            body {
                font-family: Helvetica;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            canvas {
                margin: 0;
                padding: 0;
            }
            #ctx {
                width: 100%;
                height: 100%;
            }
            html {
                height: 100%;
                background: url(./assets/images/background3.png) no-repeat
                    center center fixed;
                -webkit-background-size: cover;
                -moz-background-size: cover;
                -o-background-size: cover;
                background-size: cover;
            }
            @keyframes instructAnim{
                from {top:-500px; opacity:0;}
                to {top:1; opacity:1;}
            }
            @keyframes endAnim{
                from {top:-500px; opacity:0;}
                to {top:1; opacity:1;}
            }
        </style>
    </head>
    <body>
        <canvas id="ctx"></canvas>
        <div
            id="instructions"
            style="position:absolute; top:20%; left:27.5%; width:45%; height:width;
            border: 3px solid black; background:blanchedalmond; text-align: center; display: none;
            animation-name: instructAnim; animation-duration: 0.3s"
        >
            <h1 style="font-size:4vmin">INSTRUCTIONS</h1>
            <p id="instructText" style="font-size:3.5vmin"></p>
            <!-- <p id="scoreInstruct" style="font-size:3.5vmin"></p>
            <p id="timeInstruct" style="font-size:3.5vmin"></p>
            <p id="instructionText" style="font-size:3.5vmin"></p> -->
            <button
                id="startBtn"
                style="font-size:4.5vmin;"
                onclick="startNewGame()"
            >
                Start Game
            </button>
            <button
                id="mainBtn"
                style="font-size:4.5vmin;"
                onclick="window.location.href='./mainmenu.html'"
            >
                Main Menu
            </button>
        </div>
        <!-- <div
            id="instructionsBTN"
            style="position:absolute; top:63.75%; left:32.5%; width:35%; height:5%; border-bottom: 3px solid black; border-left: 3px solid black; border-right: 3px solid black; background:blanchedalmond; text-align: center; display: none"
        >
            <button
                id="startBtn"
                style="position: absolute; top:5%; left:25%; width:50%; height:45%; font-size:1.5vmin;"
                onclick="startNewGame()"
            >
                Start Game
            </button>
            <button
                id="mainBtn"
                style="position: absolute; top:55%; left:25%; width:50%; height:45%; font-size:1.5vmin;"
                onclick="window.location.href='./mainmenu.html'"
            >
                Main Menu
            </button>
        </div> -->
        <div
            id="stats"
            style="position:absolute; 
            top: 1.5%; left: 1%; width: 10%; height: width; 
            border-left: 1px solid black; border:  1px solid black; 
            background-image: url( './assets/images/stats.png' ); text-align: left; display: none;"
        >
            <h3 id="healthStat" style="font-size:3vmin"></h3>
            <h3 id="scoreStat" style="font-size:3vmin"></h3>
            <h3 id="timeStat" style="font-size:3vmin"></h3>
        </div>
        <div
            id="end"
            style="position:absolute; top:22.5%; left:32.5%; width:35%; height:width;
            border: 3px solid black; background:blanchedalmond; text-align: center; display: none;
            animation-name: endAnim; animation-duration: 0.3s"
        >
            <h1 style="font-size:4vmin">Time's Up!</h1>
            <p id="scoreText" style="font-size:3.5vmin"></p>
            <p id="healthText" style="font-size:3.5vmin"></p>
            <p id="tappedText" style="font-size:3.5vmin"></p>
            <p id="rubbishText" style="font-size:3.5vmin"></p>
            <p id="animalsText" style="font-size:3.5vmin"></p>
            <button
                id="newBtn"
                style="font-size:4.5vmin;"
                onclick="startNewGame()"
            >
                New Game
            </button>
            <button
                id="mainBtn"
                style="font-size:4.5vmin;"
                onclick="window.location.href='./mainmenu.html'"
            >
                Main Menu
            </button>
        </div>
        <!-- <div
            id="endBTN"
            style="position:absolute; top:63.75%; left:32.5%; width:35%; height:5%; border-bottom: 3px solid black; border-left: 3px solid black; border-right: 3px solid black; background:blanchedalmond; text-align: center; display: none"
        >
            <button
                id="startBtn"
                style="position: absolute; top:5%; left:25%; width:50%; height:45%; font-size:1.5vmin;"
                onclick="startNewGame()"
            >
                Start Game
            </button>
            <button
                id="mainBtn"
                style="position: absolute; top:55%; left:25%; width:50%; height:45%; font-size:1.5vmin;"
                onclick="window.location.href='./mainmenu.html'"
            >
                Main Menu
            </button>
        </div> -->
    </body>
    <script>
        var canvas = document.getElementById("ctx");
        var ctx = canvas.getContext("2d");
        ctx.font = "30px Helvetica";

        canvasClick = function(event) {
            var tempW = 50;
            var tempH = 50;
            var { clientX, clientY } = event;
            var ent = {
                x: clientX,
                y: clientY,
                width: tempW,
                height: tempH
            };
            for (var key in rubbishList) {
                if (testCollisionEntity(ent, rubbishList[key])) {
                    delete rubbishList[key];
                    score += 10;
                    tappedRubbish += 1;
                }
                ctx.fillRect(
                    ent.x - tempW / 2,
                    ent.y - tempH / 2,
                    ent.width,
                    ent.height
                );
            }
            for (var key in animalList) {
                if (testCollisionEntity(ent, animalList[key])) {
                    delete animalList[key];
                    score -= 20;
                    health -= 20;
                    tappedAnimals += 1;
                }
                ctx.fillRect(
                    ent.x - tempW / 2,
                    ent.y - tempH / 2,
                    ent.width,
                    ent.height
                );
            }
            delete ent;
        };

        canvas.addEventListener("click", canvasClick);

        var timeWhenGameStarted = Date.now();

        var timeOut = 10;

        var backgroundObj = {};

        var backgroundID = 0;

        var rubbishID = 0;

        var animalID = 0;

        var frameCount = 0;

        var tappedRubbish = 0;

        var tappedAnimals = 0;

        var score;

        var health;

        var rubbishList = {};

        var animalList = {};

        var imgPaths = {
            bg1: "./assets/images/background3.png",
            bg2: "./assets/images/background4.png",
            r1: "./assets/images/rubbish1.png",
            r2: "./assets/images/rubbish2.png",
            r3: "./assets/images/rubbish3.png",
            rf1: "./assets/images/rubbish1F.png",
            rf2: "./assets/images/rubbish2F.png",
            rf3: "./assets/images/rubbish3F.png",
            a1: "./assets/images/wateranimal1.png",
            a2: "./assets/images/wateranimal2.png",
            a3: "./assets/images/wateranimal3.png",
            af1: "./assets/images/wateranimal1F.png",
            af2: "./assets/images/wateranimal2F.png",
            af3: "./assets/images/wateranimal3F.png"
        };

        var img0 = new Image();
        img0.src = imgPaths.bg1;

        var img1 = new Image();
        img1.src = imgPaths.bg2;

        var img2 = new Image();
        img2.src = imgPaths.r1;

        var img3 = new Image();
        img3.src = imgPaths.r2;

        var img4 = new Image();
        img4.src = imgPaths.r3;

        var img5 = new Image();
        img5.src = imgPaths.rf1;

        var img6 = new Image();
        img6.src = imgPaths.rf2;

        var img7 = new Image();
        img7.src = imgPaths.rf3;

        var img8 = new Image();
        img8.src = imgPaths.a1;

        var img9 = new Image();
        img9.src = imgPaths.a2;

        var img10 = new Image();
        img10.src = imgPaths.a3;

        var img11 = new Image();
        img11.src = imgPaths.af1;

        var img12 = new Image();
        img12.src = imgPaths.af2;

        var img13 = new Image();
        img13.src = imgPaths.af3;

        var imgList = [
            img0,
            img1,
            img2,
            img3,
            img4,
            img5,
            img6,
            img7,
            img8,
            img9,
            img10,
            img11,
            img12,
            img13
        ];

        Image = function(id, imgId) {
            var img = new Image();
            img.src = imgPaths[imgId];

            imgList[id] = img;
        };

        Background = function(imgId) {
            var background = {
                imgId: imgId
            };
            backgroundObj = background;
        };

        Rubbish = function(id, x, y, spdX, spdY, width, height, imgId, side) {
            var rubbish = {
                x: x,
                spdX: spdX,
                y: y,
                spdY: spdY,
                id: id,
                width: width,
                height: height,
                imgId: imgId,
                side: side
            };
            rubbishList[id] = rubbish;
        };

        Animal = function(id, x, y, spdX, width, height, imgId, side) {
            var animal = {
                x: x,
                spdX: spdX,
                y: y,
                spdY: 0,
                id: id,
                width: width,
                height: height,
                imgId: imgId,
                side: side
            };
            animalList[id] = animal;
        };

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
        }

        randomlyGenerateRubbish = function() {
            if (health > -10000) {
                var side = getRandomInt(0, 2);
                var x = getRandomInt(canvas.width * 0.45, canvas.width * 0.56);
                var y = canvas.height * 0.1;
                // var height = 10 + Math.random() * 30;
                // var width = 10 + Math.random() * 30;
                var height = canvas.height / 10;
                var width = canvas.width / 12;
                var id = rubbishID++;
                // var spdX =
                //     20 +
                //     Math.random() * 20 +
                //     (frameCount / 1000) * (frameCount / 1000);
                var spdX = 20 + Math.random() * 20 * (side == 0 ? 2 : -3);
                var spdY = 2 + Math.random() * 2 + frameCount / 1000;
                var imgId = getRandomInt(2, 5);
                Rubbish(id, x, y, spdX, spdY, width, height, imgId, side);
            }
        };

        randomlyGenerateAnimal = function() {
            if (health > -10000) {
                var side = getRandomInt(0, 2);
                if (side == 0) {
                    var x = 0;
                } else {
                    var x = canvas.width;
                }
                var y = getRandomInt(
                    canvas.height * 0.38,
                    canvas.height * 0.95
                );
                // var height = 10 + Math.random() * 30;
                // var width = 10 + Math.random() * 30;
                var height = canvas.height / 7.5;
                var width = canvas.width / 10;
                var id = animalID++;
                var spdX = 1 + Math.random() * 20 * (side == 0 ? 1 : -1);
                var imgId = getRandomInt(8, 11);
                Animal(id, x, y, spdX, width, height, imgId, side);
            }
        };

        updateRubbishEntity = function(something) {
            updateRubbishPosition(something);
            drawEntity(something);
        };

        updateAnimalEntity = function(something) {
            updateAnimalPosition(something);
            drawEntity(something);
        };

        updateRubbishPosition = function(something) {
            something.x += something.spdX;
            something.y += something.spdY;
            something.spdY += 0.5;

            // if (something.spdX > 0) {
            //     something.spdX -= 0.3;
            // } else if (something.spdX < 0) {
            //     something.spdX += 0.3;
            // }

            if (something.x < 0 || something.x > canvas.width) {
                something.spdX *= -1;
            }

            if (something.y > canvas.height - 10) {
                // health -= 15;
                // score -= 10;
                for (var key in rubbishList) {
                    if (something === rubbishList[key]) {
                        delete rubbishList[key];
                    }
                }
            }
        };

        updateAnimalPosition = function(something) {
            something.x += something.spdX;

            if (something.side == 0) {
                if (something.x > canvas.width) {
                    for (var key in animalList) {
                        if (something === animalList[key]) {
                            delete animalList[key];
                        }
                    }
                }
            } else {
                if (something.x < 0) {
                    for (var key in animalList) {
                        if (something === animalList[key]) {
                            delete animalList[key];
                        }
                    }
                }
            }
        };

        drawEntity = function(something) {
            ctx.save();

            ctx.drawImage(
                imgList[something.imgId + something.side * 3],
                something.x - something.width / 2,
                something.y - something.height / 2,
                something.width,
                something.height
            );
            ctx.restore();
        };

        getDistanceBetweenEntity = function(entity1, entity2) {
            var vx = entity1.x - entity2.x;
            var vy = entity1.y - entity2.y;
            return Math.sqrt(vx * vx + vy * vy);
        };

        testCollisionEntity = function(entity1, entity2) {
            var rect1 = {
                x: entity1.x - entity1.width / 2,
                y: entity1.y - entity1.height / 2,
                width: entity1.width,
                height: entity1.height
            };

            var rect2 = {
                x: entity2.x - entity2.width / 2,
                y: entity2.y - entity2.height / 2,
                width: entity2.width,
                height: entity2.height
            };

            return testCollisionRectRect(rect1, rect2);
        };

        testCollisionRectRect = function(rect1, rect2) {
            return (
                rect1.x <= rect2.x + rect2.width &&
                rect2.x <= rect1.x + rect1.width &&
                rect1.y <= rect2.y + rect2.height &&
                rect2.y <= rect1.y + rect1.height
            );
        };

        document.getElementById("instructions").style.display = "block";
        document.getElementById("instructText").innerHTML =
            "Health lowers when rubbish hits the ground<br/><br/>" +
            "Score increases when you destroy rubbish<br/><br/>" + 
            "Time is how long the current round has left<br/><br/>" +
            "Be careful not to tap animals!";
        // document.getElementById("scoreInstruct").innerHTML =
        //     "Score increases when you destroy rubbish";
        // document.getElementById("timeInstruct").innerHTML =
        //     "Time is how long the current round has left";
        // document.getElementById("instructionText").innerHTML =
        //     "Be careful not to tap animals!";

        update = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frameCount++;
            var time = (new Date() - timeWhenGameStarted) / 1000;
            var t = time.toFixed(1);
            var roundTime = timeOut - t;
            var timeLeft = roundTime.toFixed(1);

            if (frameCount % 20 == 0) {
                randomlyGenerateRubbish();
            }

            if (frameCount % 20 == 0) {
                randomlyGenerateAnimal();
            }

            if (health <= 50) {
                // backgroundObj.imgId = 1;
                document.getElementById("rootObject").style = 
                "background: url(./assets/images/background4.png) no-repeat center center fixed; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; background-size: cover;";
            }
            else {
                document.getElementById("rootObject").style = 
                "background: url(./assets/images/background3.png) no-repeat center center fixed; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; background-size: cover;";
            }

            // ctx.drawImage(
            //     imgList[backgroundObj.imgId],
            //     0,
            //     0,
            //     this.width,
            //     this.height,
            //     0,
            //     0,
            //     (ctx.canvas.width = innerWidth),
            //     (ctx.canvas.height = innerHeight)
            // );

            for (var key in rubbishList) {
                updateRubbishEntity(rubbishList[key]);
            }

            for (var key in animalList) {
                updateAnimalEntity(animalList[key]);
            }

            if (time >= 10) {
                myStopFunction();
                health = health;
                for (var key in rubbishList) {
                    delete rubbishList[key];
                }
                rubbishList = {};

                for (var key in animalList) {
                    delete animalList[key];
                }
                animalList = {};

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                document.getElementById("end").style.display = "block";
                document.getElementById("scoreText").innerHTML =
                    "Score: " + score;
                document.getElementById("healthText").innerHTML =
                    "Health: " + health;
                document.getElementById("tappedText").innerHTML =
                    "You got rid of: ";
                if (tappedRubbish < 1 || tappedRubbish > 1) {
                    document.getElementById("rubbishText").innerHTML =
                        tappedRubbish + " pieces of rubbish";
                } else if (tappedRubbish == 1) {
                    document.getElementById("rubbishText").innerHTML =
                        tappedRubbish + " piece of rubbish";
                }
                if (tappedAnimals < 1 || tappedAnimals > 1) {
                    document.getElementById("animalsText").innerHTML =
                        tappedAnimals + " animals";
                } else if (tappedAnimals == 1) {
                    document.getElementById("animalsText").innerHTML =
                        tappedAnimals + " animal";
                }
            }
            document.getElementById("stats").style.display = "block";
            document.getElementById("healthStat").innerHTML =
                "Health: " + health;
            document.getElementById("scoreStat").innerHTML = "Score: " + score;
            document.getElementById("timeStat").innerHTML = "Time: " + timeLeft;
        };

        var myVar;

        startNewGame = function() {
            ctx.canvas.width = innerWidth;
            ctx.canvas.height = innerHeight;
            document.getElementById("end").style.display = "none";
            document.getElementById("instructions").style.display = "none";
            timeWhenGameStarted = Date.now();
            frameCount = 0;
            timeOut = 10;
            health = 100;
            score = 0;
            tappedRubbish = 0;
            tappedAnimals = 0;
            Background(0);
            rubbishList = {};
            animalList = {};
            randomlyGenerateRubbish();
            randomlyGenerateAnimal();
            myVar = setInterval(update, 40);
        };

        function myStopFunction() {
            clearInterval(myVar);
        }
    </script>
</html>
