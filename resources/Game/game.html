<!DOCTYPE html>
<html id="rootObject">
    <head>
        <style>
            body {
                font-family: Helvetica;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            canvas {
                margin: 0;
                padding: 0;
            }
            #ctx {
                width: 100%;
                height: 100%;
            }
            html {
                height: 100%;
                background: url(./assets/images/background5.png) no-repeat
                    center center fixed;
                -webkit-background-size: cover;
                -moz-background-size: cover;
                -o-background-size: cover;
                background-size: cover;
            }
            @keyframes menuAnim{
                from {top:-500px; opacity:0;}
                to {top:1; opacity:1;}
            }
        </style>
    </head>
    <body>
        <canvas id="ctx"></canvas>
        <div
            id="levelSelect"
            style="position:absolute; top:20%; left:30%; width:40%; height:width; 
            border: 3px solid black; background:blanchedalmond; text-align: center; display: none; 
            animation-name: menuAnim; animation-duration: 0.3s"
        >
            <h1 style="font-size:4vmin">LEVEL SELECT</h1>
            <h3 id="selectText" style="font-size:3.5vmin"></h3>
            <button
                id="survivalBtn"
                style="font-size:4.5vmin;"
                onclick="survivalInstructMenu()"
            >
                Survival
            </button>
            <button
                id="timedBtn"
                style="font-size:4.5vmin;"
                onclick="timedInstructMenu()"
            >
                Timed
            </button>
        </div>
        <div
            id="survivalInstructions"
            style="position:absolute; top:15%; left:20%; width:60%; height:width;
            border: 3px solid black; background:blanchedalmond; text-align: center; display: none;
            animation-name: menuAnim; animation-duration: 0.3s"
        >
            <h1 style="font-size:4vmin">INSTRUCTIONS</h1>
            <p id="survivalInstructText" style="font-size:3.5vmin"></p>
            <button
                id="startBtn"
                style="font-size:4.5vmin;"
                onclick="startNewGame()"
            >
                Start Game
            </button>
            <button
                id="mainBtn"
                style="font-size:4.5vmin;"
                onclick="mainMenu()"
            >
                Main Menu
            </button>
        </div>
        <div
            id="timedInstructions"
            style="position:absolute; top:15%; left:20%; width:60%; height:width;
            border: 3px solid black; background:blanchedalmond; text-align: center; display: none;
            animation-name: menuAnim; animation-duration: 0.3s"
        >
            <h1 style="font-size:4vmin">INSTRUCTIONS</h1>
            <p id="timedInstructText" style="font-size:3.5vmin"></p>
            <button
                id="startBtn"
                style="font-size:4.5vmin;"
                onclick="startNewGame()"
            >
                Start Game
            </button>
            <button
                id="mainBtn"
                style="font-size:4.5vmin;"
                onclick="mainMenu()"
            >
                Main Menu
            </button>
        </div>
        <div
            id="stats"
            style="position:absolute; 
            top: 1.5%; left: 1%; width: 10%; height: width; 
            border-left: 1px solid black; border:  1px solid black; 
            background-image: url( './assets/images/stats.png' ); text-align: left; display: none;"
        >
            <h3 id="statText" style="font-size:3vmin"></h3>
        </div>
        <div
            id="end"
            style="position:absolute; top:15%; left:25%; width:50%; height:width; 
            border: 3px solid black; background:blanchedalmond; text-align: center; display: none;
            animation-name: menuAnim; animation-duration: 0.3s"
        >
            <h1 style="font-size:4vmin">Game Over</h1>
            <p id="endText" style="font-size:3.5vmin"></p>
            <button
                id="newBtn"
                style="font-size:4.5vmin;"
                onclick="startNewGame()"
            >
                New Game
            </button>
            <button
                id="mainBtn"
                style="font-size:4.5vmin;"
                onclick="mainMenu()"
            >
                Main Menu
            </button>
        </div>
    </body>
    <script>
        var canvas = document.getElementById("ctx");
        var ctx = canvas.getContext("2d");
        ctx.font = "30px Helvetica";

        canvasClick = function(event) {
            var tempW = 50;
            var tempH = 50;
            var { clientX, clientY } = event;
            var ent = {
                x: clientX,
                y: clientY,
                width: tempW,
                height: tempH
            };
            for (var key in rubbishList) {
                if (testCollisionEntity(ent, rubbishList[key])) {
                    delete rubbishList[key];
                    score += 10;
                    tappedRubbish += 1;
                }
            }
            for (var key in animalList) {
                if (testCollisionEntity(ent, animalList[key])) {
                    delete animalList[key];
                    score -= 15;
                    health -= 20;
                    tappedAnimals += 1;
                }
            }
            for (var key in pestList) {
                if (testCollisionEntity(ent, pestList[key])) {
                    delete pestList[key];
                    score += 35;
                    health += 10;
                    tappedPests += 1;
                }
            }
            delete ent;
        };

        canvas.addEventListener("click", canvasClick);

        var mode = 0;

        var timeWhenGameStarted = Date.now();

        var timeOut = 30;

        var backgroundObj = {};

        var backgroundID = 0;

        var rubbishID = 0;

        var animalID = 0;

        var pestID = 0;

        var frameCount = 0;

        var tappedRubbish = 0;

        var tappedAnimals = 0;

        var tappedPests = 0;

        var score;

        var health;

        var rubbishList = {};

        var animalList = {};

        var pestList = {};

        var imgPaths = [
            "./assets/images/background1.png",
            "./assets/images/background2.png",
            "./assets/images/background3.png",
            "./assets/images/background4.png",
            "./assets/images/background5.png",
            "./assets/images/rubbish1.png",
            "./assets/images/rubbish2.png",
            "./assets/images/rubbish3.png",
            "./assets/images/rubbish1F.png",
            "./assets/images/rubbish2F.png",
            "./assets/images/rubbish3F.png",
            "./assets/images/animal1.png",
            "./assets/images/animal2.png",
            "./assets/images/animal3.png",
            "./assets/images/animal1F.png",
            "./assets/images/animal2F.png",
            "./assets/images/animal3F.png",
            "./assets/images/wateranimal1.png",
            "./assets/images/wateranimal2.png",
            "./assets/images/wateranimal3.png",
            "./assets/images/wateranimal1F.png",
            "./assets/images/wateranimal2F.png",
            "./assets/images/wateranimal3F.png",
            "./assets/images/pest1.png",
            "./assets/images/pest2.png",
            "./assets/images/pest3.png",
            "./assets/images/pest1F.png",
            "./assets/images/pest2F.png",
            "./assets/images/pest3F.png"
        ];

        var imgList = [];

        for (var i = 0; i < 29; i++){
            var img = new Image();
            img.src = imgPaths[i];
            imgList.push(img);
        }

        Image = function(id, imgId) {
            var img = new Image();
            img.src = imgPaths[imgId];

            imgList[id] = img;
        };

        Background = function(imgId) {
            var background = {
                imgId: imgId
            };
            backgroundObj = background;
        };

        Rubbish = function(id, x, y, spdX, spdY, width, height, imgId, side) {
            var rubbish = {
                x: x,
                spdX: spdX,
                y: y,
                spdY: spdY,
                id: id,
                width: width,
                height: height,
                imgId: imgId,
                side: side
            };
            rubbishList[id] = rubbish;
        };

        Animal = function(id, x, y, spdX, width, height, imgId, side) {
            var animal = {
                x: x,
                spdX: spdX,
                y: y,
                spdY: 0,
                id: id,
                width: width,
                height: height,
                imgId: imgId,
                side: side
            };
            animalList[id] = animal;
        };

        Pest = function(id, x, y, spdX, width, height, imgId, side) {
            var pest = {
                x: x,
                spdX: spdX,
                y: y,
                spdY: 0,
                id: id,
                width: width,
                height: height,
                imgId: imgId,
                side: side
            };
            pestList[id] = pest;
        };

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
        }

        randomlyGenerateRubbish = function() {
            if (health > -10000) {
                var side = getRandomInt(0, 2);
                if (mode == 1){
                    var x = Math.random() * (canvas.width - 10) + 10;
                    var y = 0;
                }
                else if (mode == 2){
                    var x = getRandomInt(canvas.width * 0.45, canvas.width * 0.56);
                    var y = canvas.height * 0.1;
                }
                var height = canvas.height / 10;
                var width = canvas.width / 12;
                var id = rubbishID++;
                var spdX = 20 + Math.random() * 20 * (side == 0 ? 1.5 : -3);
                var spdY = 2 + Math.random() * 2 + frameCount / 1000;
                var imgId = getRandomInt(5,8);
                Rubbish(id, x, y, spdX, spdY, width, height, imgId, side);  
            }
        };

        randomlyGenerateAnimal = function() {
            if (health > -10000) {
                var side = getRandomInt(0, 2);
                if (side == 0) {
                    var x = 0;
                } else {
                    var x = canvas.width;
                }
                if (mode == 1){
                    var y = canvas.height * 0.95;
                }
                else if (mode == 2){
                    var y = getRandomInt(
                        canvas.height * 0.38,
                        canvas.height * 0.95
                    );
                }
                var height = canvas.height / 7.5;
                var width = canvas.width / 10;
                var id = animalID++;
                var spdX = 1 + Math.random() * 20 * (side == 0 ? 1 : -1);
                if (mode == 1){
                    var imgId = getRandomInt(11, 14);
                }
                else if (mode == 2){
                    var imgId = getRandomInt(17, 20);
                }
                Animal(id, x, y, spdX, width, height, imgId, side);
            }
        };

        randomlyGeneratePest = function() {
            if (mode == 1){
                if (health > 0) {
                    var side = getRandomInt(0, 2);
                    if (side == 0) {
                        var x = 0;
                    } else {
                        var x = canvas.width;
                    }
                    var y = canvas.height * 0.95;
                    var height = canvas.height / 7.5;
                    var width = canvas.width / 10;
                    var id = pestID++;
                    var spdX = 1 + Math.random() * 20 * (side == 0 ? 1 : -1);
                    var imgId = getRandomInt(23, 26);
                    Pest(id, x, y, spdX, width, height, imgId, side);
                }
            }    
        };

        updateRubbishEntity = function(something) {
            updateRubbishPosition(something);
            drawEntity(something);
        };

        updateAnimalEntity = function(something) {
            updateAnimalPosition(something);
            drawEntity(something);
        };

        updatePestEntity = function(something) {
            updatePestPosition(something);
            drawEntity(something);
        };

        updateRubbishPosition = function(something) {
            something.x += something.spdX;
            something.y += something.spdY;
            something.spdY += 0.5;

            if (something.x < 0 || something.x > canvas.width) {
                something.spdX *= -1;
            }

            if (something.y > canvas.height - 10) {
                health -= 15;
                score -= 5;
                for (var key in rubbishList) {
                    if (something === rubbishList[key]) {
                        delete rubbishList[key];
                    }
                }
            }
        };

        updateAnimalPosition = function(something) {
            something.x += something.spdX;

            if (something.side == 0) {
                if (something.x > canvas.width) {
                    for (var key in animalList) {
                        if (something === animalList[key]) {
                            delete animalList[key];
                        }
                    }
                }
            } else {
                if (something.x < 0) {
                    for (var key in animalList) {
                        if (something === animalList[key]) {
                            delete animalList[key];
                        }
                    }
                }
            }
        };

        updatePestPosition = function(something) {
            if (mode == 1){
                something.x += something.spdX;

                if (something.side == 0) {
                    if (something.x > canvas.width) {
                        for (var key in pestList) {
                            if (something === pestList[key]) {
                                delete pestList[key];
                            }
                        }
                    }
                    if (something.x > canvas.width - 10) {
                        health -= 30;
                        score -= 10;
                        for (var key in pestList) {
                            if (something === pestList[key]) {
                                delete pestList[key];
                            }
                        }
                    }
                }
                else if (something.side == 1) {
                    if (something.x < 0) {
                        for (var key in pestList) {
                            if (something === pestList[key]) {
                                delete pestList[key];
                            }
                        }
                    }
                    if (something.x < 0) {
                        health -= 30;
                        score -= 10;
                        for (var key in pestList) {
                            if (something === pestList[key]) {
                                delete pestList[key];
                            }
                        }
                    }
                }
            }
        };

        drawEntity = function(something) {
            ctx.save();

            ctx.drawImage(
                imgList[something.imgId + something.side * 3],
                something.x - something.width / 2,
                something.y - something.height / 2,
                something.width,
                something.height
            );
            ctx.restore();
        };

        testCollisionEntity = function(entity1, entity2) {
            var rect1 = {
                x: entity1.x - entity1.width / 2,
                y: entity1.y - entity1.height / 2,
                width: entity1.width,
                height: entity1.height
            };

            var rect2 = {
                x: entity2.x - entity2.width / 2,
                y: entity2.y - entity2.height / 2,
                width: entity2.width,
                height: entity2.height
            };

            return testCollisionRectRect(rect1, rect2);
        };

        testCollisionRectRect = function(rect1, rect2) {
            return (
                rect1.x <= rect2.x + rect2.width &&
                rect2.x <= rect1.x + rect1.width &&
                rect1.y <= rect2.y + rect2.height &&
                rect2.y <= rect1.y + rect1.height
            );
        };

        document.getElementById("levelSelect").style.display = "block";
        document.getElementById("selectText").innerHTML =
        "Choose which mode you want to play:<br/><br/>" + 
        "Survival mode keeps going until your health reaches 0<br/><br/>" +
        "Timed mode is about getting the highest score possible in a set amount of time";

        survivalInstructMenu = function(){
            document.getElementById("survivalInstructions").style.display = "block";
            document.getElementById("survivalInstructText").innerHTML =
            "Health lowers when rubbish hits the ground or pests make it through<br/><br/>" +
            "(there are no pests in timed mode)<br/><br/>" +
            "Score increases when you destroy rubbish or pests<br/><br/>" +
            "In Survival Time is how long the current round has lasted, in Timed it's how long is left<br/><br/>" +
            "Tap rubbish or pests, be careful not to tap non-pests!";
            document.getElementById("levelSelect").style.display = "none";
            mode = 1;
        }  

        timedInstructMenu = function(){
            document.getElementById("timedInstructions").style.display = "block";
            document.getElementById("timedInstructText").innerHTML =
            "Health lowers when rubbish hits the ground or pests make it through<br/><br/>" +
            "(there are no pests in timed mode)<br/><br/>" +
            "Score increases when you destroy rubbish or pests<br/><br/>" +
            "In Survival Time is how long the current round has lasted, in Timed it's how long is left<br/><br/>" +
            "Tap rubbish or pests, be careful not to tap non-pests!";
            document.getElementById("levelSelect").style.display = "none";
            mode = 2;
        }  

        mainMenu = function(){
            document.getElementById("levelSelect").style.display = "block";
            document.getElementById("selectText").innerHTML =
            "Choose which mode you want to play:<br/><br/>" + 
            "Survival mode keeps going until your health reaches 0<br/><br/>" +
            "Timed mode is about getting the highest score possible in a set amount of time";
            document.getElementById("survivalInstructions").style.display = "none";
            document.getElementById("timedInstructions").style.display = "none";
            document.getElementById("stats").style.display = "none";
            document.getElementById("end").style.display = "none";
            document.getElementById("rootObject").style = 
                "background: url(./assets/images/background5.png) no-repeat center center fixed; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; background-size: cover;";
            mode = 0;
        }  

        update = function() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            frameCount++;

            var time = (new Date() - timeWhenGameStarted) / 1000;
            var t = time.toFixed(1);

            var roundTime = timeOut - t;
            var timeLeft = roundTime.toFixed(1);

            if (frameCount % 30 == 0) {
                randomlyGenerateRubbish();
            }

            if (mode == 1){
                if (frameCount % 45 == 0) {
                    randomlyGenerateAnimal();
                }
            }
            else if (mode == 2){
                if (frameCount % 25 == 0) {
                    randomlyGenerateAnimal();
                }
            }

            if (mode == 1){
                if (frameCount % 50 == 0) {
                    randomlyGeneratePest();
                }
            }   

            if (mode == 1){
                if (health <= 50) {
                    document.getElementById("rootObject").style = 
                    "background: url(./assets/images/background2.png) no-repeat center center fixed; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; background-size: cover;";
                }
                else {
                    document.getElementById("rootObject").style = 
                    "background: url(./assets/images/background1.png) no-repeat center center fixed; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; background-size: cover;";
                }
            }
            else if (mode == 2){
                if (health <= 50) {
                    document.getElementById("rootObject").style = 
                    "background: url(./assets/images/background4.png) no-repeat center center fixed; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; background-size: cover;";
                }
                else {
                    document.getElementById("rootObject").style = 
                    "background: url(./assets/images/background3.png) no-repeat center center fixed; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; background-size: cover;";
                }
            }
            

            for (var key in rubbishList) {
                updateRubbishEntity(rubbishList[key]);
            }

            for (var key in animalList) {
                updateAnimalEntity(animalList[key]);
            }

            if (mode == 1){
                for (var key in pestList) {
                    updatePestEntity(pestList[key]);
                }
            }  

            if (mode == 1 && health <= 0 || mode == 2 && time >= 30) {
                if (mode == 1){
                    myStopFunction();
                    health = 0;
                }
                else if (mode == 2){
                    myStopFunction();
                    health = health;
                }

                for (var key in rubbishList) {
                    delete rubbishList[key];
                }
                rubbishList = {};

                for (var key in animalList) {
                    delete animalList[key];
                }
                animalList = {};

                if (mode == 1){
                    for (var key in pestList) {
                        delete pestList[key];
                    }
                    pestList = {};
                }
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                document.getElementById("end").style.display = "block";
                if (mode == 1){
                    document.getElementById("endText").innerHTML =
                    "Score: " + score + "<br/><br/>" +
                    "Time: " + t + "<br/><br/>" +
                    "You got rid of:<br/><br/>" +
                    tappedRubbish + " piece(s) of rubbish<br/><br/>" +
                    tappedPests + " pest animal(s)<br/><br/>" +
                    tappedAnimals + " non-pest animal(s)<br/><br/>" +
                    "You Survived for: " + t + " seconds";
                }
                else if (mode == 2){
                    document.getElementById("endText").innerHTML =
                    "Score: " + score + "<br/><br/>" +
                    "Health: " + health + "<br/><br/>" +
                    "You got rid of:<br/><br/>" +
                    tappedRubbish + " piece(s) of rubbish<br/><br/>" +
                    tappedAnimals + " non-pest animal(s)<br/><br/>";
                }
            }
           
                document.getElementById("stats").style.display = "block";
                document.getElementById("statText").innerHTML = 
                "Health: " + health + "<br/><br/>" +
                "Score: " + score + "<br/><br/>" + 
                "Time: " + (mode == 1 ? t : timeLeft);
        };

        var myVar;

        startNewGame = function() {
            ctx.canvas.width = innerWidth;
            ctx.canvas.height = innerHeight;
            document.getElementById("end").style.display = "none";
            document.getElementById("levelSelect").style.display = "none";
            document.getElementById("survivalInstructions").style.display = "none";
            document.getElementById("timedInstructions").style.display = "none";
            timeWhenGameStarted = Date.now();
            frameCount = 0;
            health = 100;
            score = 0;
            tappedRubbish = 0;
            tappedAnimals = 0;
            tappedPests = 0;
            Background(0);
            rubbishList = {};
            animalList = {};
            pestList = {};
            randomlyGenerateRubbish();
            randomlyGenerateAnimal();
            randomlyGeneratePest();
            myVar = setInterval(update, 40);
        };

        function myStopFunction() {
            clearInterval(myVar);
        }
    </script>
</html>
